name: Global Filename Fixer

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘ï¼Œé¿å…é¢‘ç¹è‡ªåŠ¨è¿è¡Œ

jobs:
  fix-all-repos:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Fix All Repositories
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }} # ä½¿ç”¨ä½ çš„ PAT
          USER_NAME: "hc990275" # ä½ çš„ GitHub ç”¨æˆ·å
        run: |
          # é…ç½®å…¨å±€ Git ä¿¡æ¯
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "action@github.com"
          git config --global core.quotepath false

          python - <<EOF
          import os
          import requests
          import subprocess

          token = os.getenv('GH_TOKEN')
          username = os.getenv('USER_NAME')
          headers = {'Authorization': f'token {token}'}

          # 1. è·å–ç”¨æˆ·æ‰€æœ‰ä»“åº“
          # æ³¨æ„ï¼šè¿™é‡Œé»˜è®¤è·å–å‰ 100 ä¸ªä»“åº“ï¼Œå¦‚æœæ›´å¤šéœ€è¦åˆ†é¡µå¤„ç†
          api_url = f"https://api.github.com/user/repos?per_page=100&type=owner"
          repos = requests.get(api_url, headers=headers).json()

          for repo in repos:
              repo_name = repo['name']
              clone_url = repo['clone_url'].replace("https://", f"https://{username}:{token}@")
              
              print(f"ğŸš€ æ­£åœ¨å¤„ç†ä»“åº“: {repo_name}")
              
              # å…‹éš†ä»“åº“åˆ°ä¸´æ—¶ç›®å½•
              if os.path.exists('temp_repo'):
                  subprocess.run(["rm", "-rf", "temp_repo"])
              
              res = subprocess.run(["git", "clone", clone_url, "temp_repo"])
              if res.returncode != 0: continue

              os.chdir('temp_repo')
              
              # 2. æ£€æŸ¥å¹¶ä¿®å¤é€»è¾‘
              files = subprocess.getoutput("git ls-files").split('\n')
              fixed_count = 0
              
              for f in files:
                  if "\\\\" in f or "\"" in f:
                      original = f.strip('"')
                      try:
                          # æ ¸å¿ƒè§£ç é€»è¾‘
                          new_name = original.encode('latin-1').decode('unicode_escape').encode('latin-1').decode('utf-8')
                          if original != new_name:
                              print(f"  âœ… å‘ç°è½¬ä¹‰: {original} -> {new_name}")
                              subprocess.run(["git", "mv", original, new_name])
                              fixed_count += 1
                      except Exception as e:
                          print(f"  âŒ è§£æå¤±è´¥ {original}: {e}")
              
              # 3. æäº¤å¹¶æ¨é€
              if fixed_count > 0:
                  subprocess.run(["git", "commit", "-m", "chore: fix escaped chinese filenames globally"])
                  subprocess.run(["git", "push"])
                  print(f"  ğŸ‰ ä»“åº“ {repo_name} ä¿®å¤æˆåŠŸï¼")
              else:
                  print(f"  âœ” ä»“åº“ {repo_name} æ— éœ€ä¿®å¤ã€‚")
              
              os.chdir('..')

          EOF
