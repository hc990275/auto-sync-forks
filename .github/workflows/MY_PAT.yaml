name: Global Filename Fixer

on:
  workflow_dispatch: # ä»…æ‰‹åŠ¨è§¦å‘ï¼Œç‚¹å‡» Actions é¡µé¢é‡Œçš„ Run workflow è¿è¡Œ

jobs:
  fix-all-repos:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Fix All Repositories
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          USER_NAME: "hc990275"
        run: |
          pip install requests
          
          # æ³¨æ„ï¼šæ­¤å¤„çš„ 'EOF' ä½¿ç”¨äº†å•å¼•å·ï¼Œè¿™æå…¶å…³é”®ï¼
          # å®ƒç¡®ä¿äº†ä¸‹æ–¹çš„ Python ä»£ç ä¸­çš„åæ–œæ ï¼ˆå¦‚ '\'ï¼‰ åŸæ ·ä¼ å…¥ Pythonï¼Œä¸ä¼šè¢« Bash æå‰è½¬ä¹‰æ‰ã€‚
          python - <<'EOF'
          import os
          import requests
          import subprocess
          import urllib.parse
          import shutil

          token = os.getenv('GH_TOKEN')
          username = os.getenv('USER_NAME')
          
          if not token:
              print("âŒ é”™è¯¯ï¼šæœªè®¾ç½® GH_TOKEN ç¯å¢ƒå˜é‡ï¼")
              exit(1)

          headers = {
              'Authorization': f'token {token}',
              'Accept': 'application/vnd.github.v3+json'
          }

          subprocess.run(["git", "config", "--global", "user.name", "GitHub Action Bot"])
          subprocess.run(["git", "config", "--global", "user.email", "action@github.com"])
          subprocess.run(["git", "config", "--global", "core.quotepath", "false"])

          # è·å–æ‰€æœ‰ä»“åº“ï¼ˆåŠ å…¥åˆ†é¡µåŠŸèƒ½ï¼Œé˜²æ­¢ä»“åº“æ•°è¶…è¿‡100åªè·å–åˆ°éƒ¨åˆ†ï¼‰
          repos = []
          page = 1
          while True:
              api_url = f"https://api.github.com/user/repos?per_page=100&type=owner&page={page}"
              print(f"æ­£åœ¨è·å–ç¬¬ {page} é¡µä»“åº“...")
              try:
                  response = requests.get(api_url, headers=headers)
                  response.raise_for_status()
                  page_repos = response.json()
                  if not page_repos:
                      break
                  repos.extend(page_repos)
                  page += 1
              except Exception as e:
                  print(f"âŒ è·å–ä»“åº“åˆ—è¡¨æ—¶å‡ºé”™: {e}")
                  exit(1)

          total_repos = len(repos)
          print(f"âœ… æˆåŠŸè·å–äº† {total_repos} ä¸ªä»“åº“çš„ä¿¡æ¯ï¼Œå‡†å¤‡å¼€å§‹å…¨å±€æ‰«æã€‚")

          def decode_path(path_str):
              decoded = path_str
              
              # 1. å°è¯• URL è§£ç  (é’ˆå¯¹ %E4%B8%AD è¿™ç§)
              if '%' in decoded:
                  try:
                      decoded = urllib.parse.unquote(decoded)
                  except:
                      pass
                      
              # 2. å°è¯•å…«è¿›åˆ¶è§£ç  (é’ˆå¯¹ \344\270\255 è¿™ç§)
              if '\\' in decoded:
                  try:
                      # åˆ©ç”¨ latin-1 å’Œ unicode_escape å®‰å…¨è½¬ç å‡ºçœŸÂ·ä¸­æ–‡å­—ç¬¦
                      decoded = decoded.encode('latin-1').decode('unicode_escape').encode('latin-1').decode('utf-8')
                  except:
                      pass
                      
              # 3. å¦‚æœå‰åè¿˜æœ‰åŒ…å«å¤šä½™çš„å¼•å·ï¼Œè„±å»å®ƒå¹¶å†æ¬¡å°è¯•è§£ç 
              if decoded.startswith('"') and decoded.endswith('"'):
                  decoded = decoded[1:-1]
                  if '\\' in decoded:
                      try:
                          decoded = decoded.encode('latin-1').decode('unicode_escape').encode('latin-1').decode('utf-8')
                      except:
                          pass
              
              return decoded

          # å¼€å§‹å¤„ç†æ¯ä¸€ä¸ªä»“åº“
          for repo_index, repo in enumerate(repos):
              repo_name = repo['name']
              
              repo_progress = (repo_index + 1) / total_repos * 100
              print(f"\n====================================")
              print(f">>> [æ€»ä½“è¿›åº¦: {repo_index + 1}/{total_repos} ({repo_progress:.1f}%)] æ­£åœ¨å¤„ç†ä»“åº“: {repo_name}")
              print(f"====================================")
              
              # ä½¿ç”¨ä½ çš„åå­—ä»¥åŠ PAT è®¾ç½®å…‹éš† URL
              clone_url = repo['clone_url'].replace("https://", f"https://{username}:{token}@")
              
              if os.path.exists('temp_repo'):
                  shutil.rmtree('temp_repo')
              
              if subprocess.run(["git", "clone", clone_url, "temp_repo"], capture_output=True).returncode != 0:
                  print(f"è¯¥ä»“åº“å…‹éš†å¤±è´¥: {repo_name}ï¼Œå¯èƒ½æ²¡æœ‰æƒé™ã€‚")
                  continue

              os.chdir('temp_repo')
              
              fixed_count = 0
              # ä½¿ç”¨ ls-files -z å¯ä»¥è§„é¿å› ä¸ºç©ºæ ¼/æ¢è¡Œç¬¦å¯¼è‡´æ–‡ä»¶åè¯»å–æˆªæ–­çš„é—®é¢˜ï¼Œæ˜¯æœ€åº•å±‚çš„çœŸå®éªŒè¯
              try:
                  output = subprocess.check_output(["git", "ls-files", "-z"]).decode('utf-8', errors='replace')
                  files = [f for f in output.split('\0') if f]
                  total_files = len(files)
                  print(f"  ğŸ“‚ è¯¥ä»“åº“å…±æ¢æµ‹åˆ° {total_files} ä¸ªæ–‡ä»¶...")
                  
                  for file_index, old_path in enumerate(files):
                      if not old_path.strip(): continue
                      
                      new_path = decode_path(old_path)
                      # å¦‚æœè§£ç åçš„è·¯å¾„ä¸åŒï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªè¢«è½¬ä¹‰çš„åå­—
                      if old_path != new_path:
                          # ç›®æ ‡ä¸Šçº§ç›®å½•å¿…é¡»å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™ä½¿ç”¨ os.makedirs è¡¥å…¨
                          dest_dir = os.path.dirname(new_path)
                          if dest_dir:
                              os.makedirs(dest_dir, exist_ok=True)
                          
                          # æ‰§è¡Œç§»åŠ¨æ–‡ä»¶
                          try:
                              file_progress = (file_index + 1) / total_files * 100
                              print(f"    [æ–‡ä»¶è¿›åº¦: {file_progress:.1f}%] ğŸ”§ å‘½ä¸­éœ€ä¿®å¤: {old_path} -> {new_path}")
                          except UnicodeEncodeError:
                              # å¤„ç†æç½•è§çš„æ§åˆ¶å°ç¼–ç æ‰“å°é”™è¯¯
                              pass

                          if os.path.exists(old_path):
                              try:
                                  subprocess.run(["git", "mv", "-f", old_path, new_path], check=True, capture_output=True)
                                  fixed_count += 1
                              except subprocess.CalledProcessError as e:
                                  print(f"    âŒ git mv æ“ä½œå¤±è´¥: {old_path}")
                                  pass
              except Exception as ex:
                  print(f"  âŒ å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™: {ex}")
                  
              if fixed_count > 0:
                  print(f"  âœ… [å®Œæˆ] ä¿®å¤äº† {fixed_count} å¤„é—®é¢˜ï¼Œå‡†å¤‡æ¨é€...")
                  subprocess.run(["git", "commit", "-m", "chore: ä¿®å¤ä¸­æ–‡æ–‡ä»¶ç›®å½•è½¬ä¹‰ä¸ºæ­£å¸¸æ±‰å­—"])
                  push_result = subprocess.run(["git", "push"], capture_output=True)
                  if push_result.returncode == 0:
                      print(f"  ğŸš€ æ¨é€æˆåŠŸï¼")
                  else:
                      print(f"  âŒ æ¨é€å¤±è´¥ï¼")
              else:
                  print(f"  âœ¨ [å®Œæˆ] è¯¥ä»“åº“æ‰«æå®Œæ¯•ï¼Œæœªå‘ç°ä¹±ç ã€‚")
                  
              os.chdir('..')
              shutil.rmtree('temp_repo')
              
          print("\nğŸ‰ === æ‰€æœ‰ä»“åº“å…¨å±€æ‰«æä¿®å¤å®Œæ¯• === ğŸ‰")
          EOF
