name: Global Filename Fixer

on:
  workflow_dispatch: # 仅手动触发，点击 Actions 页面里的 Run workflow 运行

jobs:
  fix-all-repos:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Fix All Repositories
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          USER_NAME: "hc990275"
        run: |
          pip install requests
          
          # 全局配置防止再次转义
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "action@github.com"
          git config --global core.quotepath false

          python - <<EOF
          import os
          import requests
          import subprocess

          token = os.getenv('GH_TOKEN')
          username = os.getenv('USER_NAME')
          headers = {
              'Authorization': f'token {token}',
              'Accept': 'application/vnd.github.v3+json'
          }

          # 获取该用户作为 owner 的所有仓库
          api_url = "https://api.github.com/user/repos?per_page=100&type=owner"
          
          try:
              response = requests.get(api_url, headers=headers)
              response.raise_for_status()
              repos = response.json()
          except Exception as e:
              print(f"Error fetching repos: {e}")
              exit(1)

          for repo in repos:
              repo_name = repo['name']
              # 使用 PAT 构建克隆 URL
              clone_url = repo['clone_url'].replace("https://", f"https://{username}:{token}@")
              
              print(f"\n>>> Checking repo: {repo_name}")
              
              if os.path.exists('temp_repo'):
                  subprocess.run(["rm", "-rf", "temp_repo"])
              
              if subprocess.run(["git", "clone", clone_url, "temp_repo"], capture_output=True).returncode != 0:
                  continue

              os.chdir('temp_repo')
              subprocess.run(["git", "config", "core.quotepath", "false"])
              
              files = subprocess.getoutput("git ls-files").split('\n')
              fixed_count = 0
              
              for f in files:
                  if "\\\\" in f:
                      old_path = f.strip('"')
                      try:
                          # 核心逻辑：解码八进制
                          new_path = old_path.encode('latin-1').decode('unicode_escape').encode('latin-1').decode('utf-8')
                          if old_path != new_path:
                              print(f"  Fixing: {old_path} -> {new_path}")
                              subprocess.run(["git", "mv", old_path, new_path])
                              fixed_count += 1
                      except:
                          continue
              
              if fixed_count > 0:
                  subprocess.run(["git", "add", "."])
                  subprocess.run(["git", "commit", "-m", "chore: fix escaped filenames (global)"])
                  subprocess.run(["git", "push"])
                  print(f"  Done!")
              else:
                  print(f"  Clean.")
              
              os.chdir('..')
              subprocess.run(["rm", "-rf", "temp_repo"])
          EOF
