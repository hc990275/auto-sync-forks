- name: Fix All Repositories
        env:
          GH_TOKEN: ${{ secrets.MY_PAT }}
          USER_NAME: "hc990275"
        run: |
          # 1. å®‰è£…å¿…è¦çš„ Python ä¾èµ–
          pip install requests

          # 2. é…ç½®å…¨å±€ Git ä¿¡æ¯ï¼ˆç¡®ä¿ä»¥åæäº¤ä¸å†è½¬ä¹‰ï¼‰
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "action@github.com"
          git config --global core.quotepath false

          # 3. è¿è¡Œä¿®å¤è„šæœ¬
          python - <<EOF
          import os
          import requests
          import subprocess

          token = os.getenv('GH_TOKEN')
          username = os.getenv('USER_NAME')
          headers = {
              'Authorization': f'token {token}',
              'Accept': 'application/vnd.github.v3+json'
          }

          # è·å–ç”¨æˆ·æ‰€æœ‰ä»“åº“ï¼ˆåŒ…æ‹¬ç§æœ‰ä»“åº“ï¼‰
          # per_page=100 æ˜¯å•é¡µä¸Šé™
          api_url = "https://api.github.com/user/repos?per_page=100&type=owner"
          
          try:
              response = requests.get(api_url, headers=headers)
              response.raise_for_status()
              repos = response.json()
          except Exception as e:
              print(f"âŒ æ— æ³•è·å–ä»“åº“åˆ—è¡¨: {e}")
              exit(1)

          for repo in repos:
              repo_name = repo['name']
              # è·³è¿‡å½“å‰æ­£åœ¨è¿è¡Œ Action çš„ä»“åº“ï¼Œé˜²æ­¢æ­»å¾ªç¯ï¼ˆå¯é€‰ï¼‰
              # if repo_name == "å½“å‰ä»“åº“å": continue
              
              # ä½¿ç”¨å¸¦æœ‰ Token çš„ URL è¿›è¡Œå…‹éš†ï¼Œç¡®ä¿æœ‰æ¨é€æƒé™
              clone_url = repo['clone_url'].replace("https://", f"https://{username}:{token}@")
              
              print(f"\n{"="*50}")
              print(f"ğŸš€ æ­£åœ¨å¤„ç†ä»“åº“: {repo_name}")
              
              if os.path.exists('temp_repo'):
                  subprocess.run(["rm", "-rf", "temp_repo"])
              
              clone_res = subprocess.run(["git", "clone", clone_url, "temp_repo"], capture_output=True)
              if clone_res.returncode != 0:
                  print(f"  âš ï¸ å…‹éš†å¤±è´¥: {repo_name}")
                  continue

              os.chdir('temp_repo')
              
              # ç¡®ä¿è¯¥ä»“åº“ä¹Ÿå…³é—­è½¬ä¹‰é…ç½®
              subprocess.run(["git", "config", "core.quotepath", "false"])
              
              # è·å–å—ç‰ˆæœ¬æ§åˆ¶çš„æ–‡ä»¶åˆ—è¡¨
              files = subprocess.getoutput("git ls-files").split('\n')
              fixed_count = 0
              
              for f in files:
                  # Git è½¬ä¹‰é€šå¸¸ä»¥å¼•å·å¼€å¤´ï¼Œæˆ–åŒ…å«åæ–œæ 
                  if "\\" in f:
                      original = f.strip('"')
                      try:
                          # å°†å…«è¿›åˆ¶è½¬ä¹‰åºåˆ—ï¼ˆå¦‚ \345ï¼‰è½¬å›ä¸­æ–‡
                          new_name = original.encode('latin-1').decode('unicode_escape').encode('latin-1').decode('utf-8')
                          if original != new_name:
                              print(f"  âœ… ä¿®å¤æ–‡ä»¶å: {original} -> {new_name}")
                              # ä½¿ç”¨ git mv ä¿æŒå†å²è®°å½•
                              subprocess.run(["git", "mv", original, new_name])
                              fixed_count += 1
                      except:
                          continue
              
              if fixed_count > 0:
                  subprocess.run(["git", "add", "."])
                  subprocess.run(["git", "commit", "-m", "chore: ä¿®å¤è¢«è½¬ä¹‰çš„ä¸­æ–‡æ–‡ä»¶å (Global Fix)"])
                  push_res = subprocess.run(["git", "push"], capture_output=True)
                  if push_res.returncode == 0:
                      print(f"  ğŸ‰ å·²æˆåŠŸæ¨é€è‡³ {repo_name}")
                  else:
                      print(f"  âŒ æ¨é€å¤±è´¥: {push_res.stderr.decode()}")
              else:
                  print(f"  âœ” æ— éœ€ä¿®å¤ã€‚")
              
              os.chdir('..')
              subprocess.run(["rm", "-rf", "temp_repo"])

          print("\nâœ¨ æ‰€æœ‰ä»“åº“æ£€æŸ¥å®Œæ¯•ï¼")
          EOF
