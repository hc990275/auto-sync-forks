name: Auto Sync Forks (Beijing Time Log)

on:
  # è®¡åˆ’ä»»åŠ¡ï¼šæ¯å°æ—¶è¿è¡Œä¸€æ¬¡ (UTCæ—¶é—´ä¸éœ€è¦æ”¹ï¼Œè„šæœ¬å†…éƒ¨ä¼šè‡ªåŠ¨ç®—åŒ—äº¬æ—¶é—´)
  schedule:
    - cron: '0 * * * *'
  # å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘
  workflow_dispatch:

permissions:
  contents: write # å…è®¸æäº¤æ—¥å¿—æ–‡ä»¶

jobs:
  sync-and-log:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Sync Forks & Rotate Logs
        shell: pwsh
        env:
          # å¿…é¡»åœ¨ä»“åº“ Settings -> Secrets ä¸­é…ç½® GH_PAT
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # =======================================================
          #  åµŒå…¥å¼ PowerShell è„šæœ¬ (æ— éœ€å¤–éƒ¨æ–‡ä»¶)
          # =======================================================
          
          # --- 1. åˆå§‹åŒ–è®¾ç½® ---
          $LogFile = "SYNC_LOG.md"
          $KeepDays = 7
          # æ‰‹åŠ¨è®¡ç®—åŒ—äº¬æ—¶é—´ (UTC + 8)
          $BeijingTime = [DateTime]::UtcNow.AddHours(8)
          $DateStr = $BeijingTime.ToString("yyyy-MM-dd HH:mm")
          $DateHeaderRegex = "## ğŸ“… (\d{4}-\d{2}-\d{2} \d{2}:\d{2})"
          
          # --- 2. æ£€æŸ¥ Token ---
          $Token = $env:GITHUB_TOKEN
          if ([string]::IsNullOrWhiteSpace($Token)) {
              Write-Error "âŒ é”™è¯¯: æœªæ£€æµ‹åˆ° GITHUB_TOKENï¼Œè¯·æ£€æŸ¥ä»“åº“ Secrets è®¾ç½®ã€‚"
              exit 1
          }
          
          $Headers = @{
              "Authorization" = "token $Token"
              "Accept"        = "application/vnd.github+json"
              "X-GitHub-Api-Version" = "2022-11-28"
          }
          $BaseUri = "https://api.github.com"

          # --- 3. è·å–æ‰€æœ‰ Fork ä»“åº“ (è‡ªåŠ¨ç¿»é¡µ) ---
          Write-Host ">>> æ­£åœ¨æ‰«æä»“åº“åˆ—è¡¨..."
          $AllRepos = @()
          $Page = 1
          do {
              $Uri = "$BaseUri/user/repos?type=owner&per_page=100&page=$Page"
              try {
                  $Response = Invoke-RestMethod -Uri $Uri -Headers $Headers -Method Get
                  if ($Response.Count -gt 0) { $AllRepos += $Response; $Page++ }
              } catch { Write-Error "API è¯·æ±‚å¤±è´¥: $($_.Exception.Message)"; exit 1 }
          } while ($Response.Count -eq 100)

          $Forks = $AllRepos | Where-Object { $_.fork -eq $true -and $_.archived -eq $false }
          Write-Host ">>> å‘ç° $($Forks.Count) ä¸ªæ´»è·ƒçš„ Fork ä»“åº“ã€‚"

          # --- 4. å¾ªç¯åŒæ­¥ ---
          $UpdateList = @()
          
          foreach ($repo in $Forks) {
              $RepoName = $repo.full_name
              $DefaultBranch = $repo.default_branch
              $SyncUri = "$BaseUri/repos/$RepoName/merge-upstream"
              $Body = @{ branch = $DefaultBranch } | ConvertTo-Json -Compress

              try {
                  $SyncResponse = Invoke-RestMethod -Uri $SyncUri -Headers $Headers -Method Post -Body $Body -ErrorAction Stop
                  
                  # åªæœ‰ update æˆåŠŸæ‰è®°å½•
                  if ($SyncResponse.message -match "Successfully fetched" -or $SyncResponse.merge_type -eq "fast-forward") {
                      $Msg = "âœ… **$RepoName** ($DefaultBranch): åŒæ­¥æˆåŠŸ"
                      Write-Host "$RepoName -> [æ›´æ–°æˆåŠŸ]" -ForegroundColor Green
                      $UpdateList += $Msg
                  } else {
                      Write-Host "$RepoName -> [æœ€æ–°]" -ForegroundColor Gray
                  }
              }
              catch {
                  $StatusCode = 0; if ($_.Exception.Response) { $StatusCode = $_.Exception.Response.StatusCode.value__ }
                  if ($StatusCode -eq 409) { Write-Host "$RepoName -> [å†²çªæˆ–æœ€æ–°]" -ForegroundColor DarkGray }
                  elseif ($StatusCode -eq 404) { Write-Host "$RepoName -> [ä¸Šæ¸¸ä¸¢å¤±]" -ForegroundColor Red }
                  else { Write-Host "$RepoName -> [é”™è¯¯ $StatusCode]" -ForegroundColor Red }
              }
              Start-Sleep -Milliseconds 100 # é˜²é™æµ
          }

          # --- 5. å¤„ç†æ—¥å¿— (å€’åº + æ¸…ç†æ—§æ—¥å¿—) ---
          
          # è¯»å–æ—§å†…å®¹
          $CurrentContent = ""
          if (Test-Path $LogFile) { $CurrentContent = Get-Content $LogFile -Raw -Encoding utf8 }
          
          # åªæœ‰å½“æœ‰æ›´æ–°æ—¶ï¼Œæ‰ç”Ÿæˆæ–°çš„æ—¥å¿—å—
          if ($UpdateList.Count -gt 0) {
              Write-Host ">>> æ£€æµ‹åˆ°æ›´æ–°ï¼Œæ­£åœ¨å†™å…¥æ—¥å¿—..."
              
              $NewBlock = "## ğŸ“… $DateStr (åŒ—äº¬æ—¶é—´)`n`n"
              foreach ($item in $UpdateList) { $NewBlock += "- $item`n" }
              $NewBlock += "`n"

              # æ‹¼æ¥ï¼šæ–‡ä»¶å¤´ + æ–°å— + (æ—§å†…å®¹å»æ‰æ–‡ä»¶å¤´)
              $Header = "# åŒæ­¥æ—¥å¿—`n`næ­¤æ–‡ä»¶ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆï¼Œä»…ä¿ç•™æœ€è¿‘ $KeepDays å¤©è®°å½•ã€‚`n`n"
              
              # å»é™¤æ—§æ–‡ä»¶å¤´ï¼Œåªä¿ç•™æ­£æ–‡éƒ¨åˆ†
              $BodyOnly = $CurrentContent -replace "^# åŒæ­¥æ—¥å¿—.*?\n\n", ""
              
              $FullContent = $Header + $NewBlock + $BodyOnly
              
              # --- 6. æ¸…ç†è¶…è¿‡7å¤©çš„è®°å½• ---
              # åˆ©ç”¨æ­£åˆ™æ‹†åˆ†æ‰€æœ‰æ—¥æœŸå—
              $Blocks = $FullContent -split "(?=## ğŸ“…)"
              $FilteredBlocks = @()
              $CutoffDate = $BeijingTime.AddDays(-$KeepDays)

              foreach ($block in $Blocks) {
                  # å°è¯•æå–æ—¥æœŸ
                  if ($block -match $DateHeaderRegex) {
                      $BlockDateStr = $Matches[1]
                      try {
                          $BlockDate = [DateTime]::ParseExact($BlockDateStr, "yyyy-MM-dd HH:mm", $null)
                          if ($BlockDate -ge $CutoffDate) {
                              $FilteredBlocks += $block
                          }
                      } catch {
                          $FilteredBlocks += $block # è§£æä¸äº†çš„ä¿ç•™ï¼Œä»¥é˜²ä¸‡ä¸€
                      }
                  } else {
                      $FilteredBlocks += $block # ä¿ç•™æ–‡ä»¶å¤´
                  }
              }
              
              $FinalContent = $FilteredBlocks -join ""
              Set-Content -Path $LogFile -Value $FinalContent -Encoding utf8
          } else {
              Write-Host ">>> æœ¬æ¬¡æ— ä»“åº“æ›´æ–°ï¼Œè·³è¿‡æ—¥å¿—å†™å…¥ã€‚"
          }

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ -n $(git status -s SYNC_LOG.md) ]]; then
            git add SYNC_LOG.md
            git commit -m "docs: update sync log [skip ci]"
            git push
            echo "âœ… æ—¥å¿—å·²æ¨é€åˆ°ä»“åº“ã€‚"
          else
            echo "âœ… æ—¥å¿—æ— å˜åŒ–ã€‚"
          fi
